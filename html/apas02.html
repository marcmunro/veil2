<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>A.2. Veil2 Views</title>
<link rel="stylesheet" type="text/css" href="veil2.css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="index.html" title="Veil2 0.9 (beta) Documentation">
<link rel="up" href="apa.html" title="A. Veil2 ERD and Database Objects">
<link rel="prev" href="apa.html" title="A. Veil2 ERD and Database Objects">
<link rel="next" href="apas03.html" title="A.3. Veil2 Functions and Triggers">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="apa.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="apa.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="apas03.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">A. <code class="literal">Veil2</code> ERD and Database Objects </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> A.3. Veil2 Functions and Triggers</td>
</tr>
</table>
<hr>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="idm1355"></a>A.2. Veil2 Views</h2></div></div></div>
<p>
    Many of the views in <code class="literal">Veil2</code> come in 3 flavours:
    </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<code class="literal">&lt;basename&gt;</code>;</li>
<li class="listitem">
<code class="literal">&lt;basename&gt;_v</code>;</li>
<li class="listitem">
<code class="literal">&lt;basename&gt;_vv</code>.</li>
</ul></div>
<p>
  </p>
<p>
    This naming convention is used to distinguish between materialized
    and non-materialized views.  A view with a
    <code class="literal">_vv</code> suffix is completely non-materialized and
    depends on no materialized views.  A view with a
    <code class="literal">_v</code> suffix is not materialized itself, but
    <span class="emphasis"><em>may</em></span> depend on materialized views in its
    definition.   A view with no suffix will be the materialized
    version (if there are matching <code class="literal">_v</code> and
    <code class="literal">_vv</code> definitions).
  </p>
<p>
    The distinction is particularly useful when debugging materialized
    view refresh mechanisms.  If there is a difference between the
    rows returned by any of these views, at least one materialized
    view needs to be refreshed.
  </p>
<p>
    There are also views named with a <code class="literal">_info</code> suffix.
    These are intended for use by developers only.  They provide the
    same data as the non <code class="literal">_info</code> version of the view,
    but with bitmaps converted to arrays.  This is simply an aid to
    understanding and debugging.  Please do not use these views for
    production purposes.
  </p>
<p>
    The following views are defined in <code class="literal">veil2/sql/views.sql</code>:
    </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<a class="link" href="apas02.html#view_direct_role_privileges" title="A.2.1. Direct Role Privileges Views">direct_role_privileges</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_role_roles" title="A.2.2. All Role Roles View">all_role_roles</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_role_privs" title="A.2.3. All Role Privs Views">all_role_privs</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_accessor_contexts" title="A.2.4. Accessor Contexts View">accessor_contexts</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_scope_promotions" title="A.2.5. Scope Promotions View">scope_promotions</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_scope_promotions" title="A.2.6. All Scope Promotions Views">all_scope_promotions</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_scope_tree" title="A.2.7. Scope Tree View">scope_tree</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_promotable_privileges" title="A.2.8. Promotable Privileges Views">promotable_privileges</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_accessor_roles" title="A.2.9. All Accessor Roles Views">all_accessor_roles</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_context_privs" title="A.2.10. All Context Privs Views">all_context_privs</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_accessor_privs" title="A.2.11. All Accessor Privs Views">all_accessor_privs</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_role_chains" title="A.2.12. Role Chains View">role_chains</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_all_accessor_roles_plus" title="A.2.13. All Accessor Roles Plus">all_accessor_roles_plus</a>;</li>
<li class="listitem">
<a class="link" href="apas02.html#view_privilege_assignments" title="A.2.14. Privilege Assignments View">privilege_assignments</a>.</li>
</ul></div>
<p>
  </p>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_direct_role_privileges"></a>A.2.1. Direct Role Privileges Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1409"></a>A.2.1.1. <code class="literal">direct_role_privileges_vv</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.direct_role_privileges_vv as
select * from veil2.direct_role_privileges_v;

</pre>
<p>
Exactly as veil2.direct_role_privileges_v.  The _vv suffix indicates
that this is a true view, not relying on any materialized views.
As it happens, direct_role_privileges_v also does not rely on any
materialized views, so this view exists only to be consistent with other
such sets of views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1412"></a>A.2.1.2. <code class="literal">direct_role_privileges_vv_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.direct_role_privileges_vv_info (
    role_id, privileges, global_privileges,
    promotable_privileges) as
select role_id, to_array(privileges),
       to_array(global_privileges), to_array(promotable_privileges)
  from veil2.direct_role_privileges_vv;

</pre>
<p>
As veil2.direct_role_privileges_vv with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1415"></a>A.2.1.3. <code class="literal">direct_role_privileges_v</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.direct_role_privileges_v (
    role_id, privileges, global_privileges,
    promotable_privileges) as
with all_role_privileges (role_id, privilege_id) as
  (
    select 1, privilege_id    -- implied privs for superuser role
      from veil2.privileges
     where privilege_id != 0  -- [all privs except connect]
     union
    select role_id, privilege_id
      from veil2.role_privileges
  )
select arp.role_id, bitmap_of(p.privilege_id),
       bitmap_of(case when p.promotion_scope_type_id = 1
       		 then p.privilege_id else null end),
       bitmap_of(case
                 when p.promotion_scope_type_id is null then null
                 when p.promotion_scope_type_id = 1 then null
                 else p.privilege_id end)
  from all_role_privileges arp
 inner join veil2.privileges p
    on p.privilege_id = arp.privilege_id
 group by arp.role_id;

</pre>
<p>
Returns all privileges, along with some basic privilege promotion data,
that are assigned directly to each role, including the implied
privileges for the superuser role.  This does not show privileges
arising from role to role assignments.
</p>
<p>
Note the use of bitmap_of() to aggregate privilege_ids.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1418"></a>A.2.1.4. <code class="literal">direct_role_privileges_v_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.direct_role_privileges_v_info (
    role_id, privileges, global_privileges,
    promotable_privileges) as
select role_id, to_array(privileges),
       to_array(global_privileges), to_array(promotable_privileges)
  from veil2.direct_role_privileges_v;

</pre>
<p>
As veil2.direct_role_privileges_v with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1421"></a>A.2.1.5. <code class="literal">direct_role_privileges</code>
</h4></div></div></div>
<pre class="programlisting">
materialized view veil2.direct_role_privileges
as select * from veil2.direct_role_privileges_v;

</pre>
<p>
Returns all privileges, along with some basic privilege promotion data,
 that are assigned directly to each role, including the implied
 privileges for the superuser role.  This does not show privileges
 arising from role to role assignments
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1424"></a>A.2.1.6. <code class="literal">direct_role_privileges_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.direct_role_privileges_info (
    role_id, privileges, global_privileges,
    promotable_privileges) as
select role_id, to_array(privileges),
       to_array(global_privileges), to_array(promotable_privileges)
  from veil2.direct_role_privileges;

</pre>
<p>
As veil2.direct_role_privileges with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_role_roles"></a>A.2.2. All Role Roles View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1429"></a>A.2.2.1. <code class="literal">all_role_roles</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_roles (
    primary_role_id, assigned_role_id,
    context_type_id, context_id) as
with recursive assigned_roles (
    primary_role_id, assigned_role_id,
    context_type_id, context_id) as
  (
    -- get all role-&gt;role assignments, both direct and indirect, in all contexts

</pre>
<p>
Show all role-&gt;role mappings in all contexts, including mappings that
are implied and those that are indirect.
</p>
<p>
Implied mappings are:
</p>
<p>
 1 - the superuser role is assigned all non-implicit roles except connect;
</p>
<p>
 2 - all roles implicitly map to themselves.
</p>
<p>
Indirect mappings occur through other mappings (ie mappings are
transitive).  Eg if a is assigned to b and b to c, then by transitivity
a is assigned (indirectly) to c.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_role_privs"></a>A.2.3. All Role Privs Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1434"></a>A.2.3.1. <code class="literal">all_role_privs_vv</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_privs_vv (
  role_id, roles,
  privileges, global_privileges, 
  promotable_privileges, context_type_id,
  context_id
) as
select arr.primary_role_id,
       bitmap_of(arr.assigned_role_id),
       union_of(drp.privileges),
       union_of(drp.global_privileges),
       union_of(drp.promotable_privileges),
       arr.context_type_id,
       arr.context_id
  from veil2.all_role_roles arr
  left outer join veil2.direct_role_privileges_vv drp
    on (   drp.role_id = arr.assigned_role_id
        or drp.role_id = arr.primary_role_id)
 group by arr.primary_role_id, arr.context_type_id, arr.context_id;

</pre>
<p>
Exactly as veil2.all_role_privs_v.  The _vv suffix indicates
that this is a true view, not relying on any materialized views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1437"></a>A.2.3.2. <code class="literal">all_role_privs_vv_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_privs_vv_info (
  role_id, roles,
  privileges, global_privileges, 
  promotable_privileges, context_type_id,
  context_id
) as
select role_id, to_array(roles),
  to_array(privileges), to_array(global_privileges), 
  to_array(promotable_privileges), context_type_id,
  context_id
from veil2.all_role_privs_vv;

</pre>
<p>
As veil2.all_role_privs_vv with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1440"></a>A.2.3.3. <code class="literal">all_role_privs_v</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_privs_v (
  role_id, roles,
  privileges, global_privileges, 
  promotable_privileges, context_type_id,
  context_id
) as
select arr.primary_role_id,
       bitmap_of(arr.assigned_role_id),
       union_of(drp.privileges),
       union_of(drp.global_privileges),
       union_of(drp.promotable_privileges),
       arr.context_type_id,
       arr.context_id
  from veil2.all_role_roles arr
  left outer join veil2.direct_role_privileges drp
    on (   drp.role_id = arr.assigned_role_id
        or drp.role_id = arr.primary_role_id)
 group by arr.primary_role_id, arr.context_type_id, arr.context_id;

</pre>
<p>
This is simply the aggregation of all role-&gt;role mappings as provided
by veil2.all_role_roles and the role_privileges as provided by
veil2.direct_role_privileges.  See the comments on those views for more
information.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1443"></a>A.2.3.4. <code class="literal">all_role_privs_v_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_privs_v_info (
  role_id, roles,
  privileges, global_privileges, 
  promotable_privileges, context_type_id,
  context_id
) as
select role_id, to_array(roles),
  to_array(privileges), to_array(global_privileges), 
  to_array(promotable_privileges), context_type_id,
  context_id
from veil2.all_role_privs_v;

</pre>
<p>
As veil2.all_role_privs_v with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1446"></a>A.2.3.5. <code class="literal">all_role_privs</code>
</h4></div></div></div>
<pre class="programlisting">
materialized view veil2.all_role_privs
as select * from veil2.all_role_privs_v;

</pre>
<p>
Materialized version of veil2.all_role_privs_v.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1449"></a>A.2.3.6. <code class="literal">all_role_privs_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_role_privs_info (
  role_id, roles,
  privileges, global_privileges, 
  promotable_privileges, context_type_id,
  context_id
) as
select role_id, to_array(roles),
  to_array(privileges), to_array(global_privileges), 
  to_array(promotable_privileges), context_type_id,
  context_id
from veil2.all_role_privs;

</pre>
<p>
As veil2.all_role_privs with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_accessor_contexts"></a>A.2.4. Accessor Contexts View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1454"></a>A.2.4.1. <code class="literal">accessor_contexts</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.accessor_contexts (
  accessor_id, context_type_id, context_id
) as
select accessor_id, 1, 0
  from veil2.accessors;

</pre>
<p>
This view lists the allowed session contexts for accessors.  When an
accessor opens a session, they choose a session context.  This session
context determines which set of role-&gt;role mappings are in play.
Typically, there will only be one such set, as provided by the default
implementation of this view.  If however, your application requires
separate contexts to have different role-&gt;role mappings, you should
modify this view to map your accessors with that context.
</p>
<p>
Typically this will be used in a situation where your application
serves a number of different clients, each of which have their own
role definitions.  Each accessor will belong to one of those clients
and this view should be modified to make that mapping apparent.
</p>
<p>
A typical view definition might be:
  select party_id, 3, client_id
</p>
<pre class="programlisting">
from app_schema.parties
</pre>
<p>
   union all 
  select party_id, 1, 0
</p>
<pre class="programlisting">
from mycorp_schema.superusers;

</pre>
<p>
which would allow those defined in the superusers table to connect in
the global context, and those defined in the parties table to connect
in the context of the client that they work for.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_scope_promotions"></a>A.2.5. Scope Promotions View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1459"></a>A.2.5.1. <code class="literal">scope_promotions</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.scope_promotions (
  scope_type_id, scope_id,
  promoted_scope_type_id, promoted_scope_id
) as
select null::integer, null::integer,
       null::integer, null::integer
where false;

</pre>
<p>
This view lists all possible direct scope promotions.  It is used
for privilege promotion when a role that is assigned in a restricted
security context has privileges that must be applied in a less
restricted scope.  Note that promotion to global scope is always
possible and is not managed through this view.
</p>
<p>
VPD Implementation Notes:
If you have restricted scopes which are sub-scopes of less
restricted ones, and you need privilege promotion for privileges
assigned in the restricted context to the less restricted one, you
should redefine this view to show which scopes may be promoted to
which other scopes.  For example if you have a corp scope type and a
dept scope type which is a sub-scope of it, and your departments table
identifies the corp_id for each deprtment, you would redefine your
view something like this:
</p>
<p>
</p>
<pre class="programlisting">
create or replace
view veil2.scope_promotions (
  scope_type_id, scope_id,
  promoted_scope_type_id, promoted_scope_id
) as
select 96, -- dept scope type id
       department_id,
       95, -- corp scope type id 
       corp_id
  from departments;

</pre>
<p>
Note that any multi-level context promotions will be handled by
veil2.all_scope_promotions which you should have no need to modify.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_scope_promotions"></a>A.2.6. All Scope Promotions Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1464"></a>A.2.6.1. <code class="literal">all_scope_promotions_vv</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_scope_promotions_vv as
select * from veil2.all_scope_promotions_v;

</pre>
<p>
Exactly as veil2.all_scope_promotions_v.  The _vv suffix indicates
that this is a true view, not relying on any materialized views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1467"></a>A.2.6.2. <code class="literal">all_scope_promotions_v</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_scope_promotions_v (
  scope_type_id, scope_id,
  promoted_scope_type_id, promoted_scope_id,
  is_type_promotion
) as
with recursive recursive_scope_promotions as
  (
    select scope_type_id, scope_id,
           promoted_scope_type_id, promoted_scope_id,
	   scope_type_id != promoted_scope_type_id
      from veil2.scope_promotions
     union
    select rsp.scope_type_id, rsp.scope_id,
           sp.promoted_scope_type_id, sp.promoted_scope_id,
	   sp.scope_type_id != sp.promoted_scope_type_id
      from recursive_scope_promotions rsp
     inner join veil2.scope_promotions sp
        on sp.scope_type_id = rsp.promoted_scope_type_id
       and sp.scope_id = rsp.promoted_scope_id
     where not (    sp.promoted_scope_type_id = rsp.promoted_scope_type_id
                and sp.promoted_scope_id = rsp.promoted_scope_id)
  )
select *
  from recursive_scope_promotions;

</pre>
<p>
This takes the simple custom view veil2.scope_promotions and makes it
recursive so that if context a contains scope b and scope b contains
scope c, then this view will return rows for scope c promoting to
both scope b and scope a.  
</p>
<p>
</p>
<p>
You should not need to modify this view when creating your custom VPD
implementation.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1470"></a>A.2.6.3. <code class="literal">all_scope_promotions</code>
</h4></div></div></div>
<pre class="programlisting">
materialized view veil2.all_scope_promotions
as select * from veil2.all_scope_promotions_v;

</pre>
<p>
This takes the simple custom view veil2.scope_promotions and makes it
recursive so that if context a contains context b and context b contains
context c, then this view will return rows for context c promoting to
both context b and context a.  
</p>
<p>
It is automatically refreshed when the veil2.scopes table is modified.
</p>
<p>
You should not need to modify this view when creating your custom VPD
implementation.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_scope_tree"></a>A.2.7. Scope Tree View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1475"></a>A.2.7.1. <code class="literal">scope_tree</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.scope_tree (scope_tree) as
with recursive
  top_scopes as
  (
    select distinct
           promoted_scope_id as root_scope_id,
	   promoted_scope_type_id as root_scope_type_id
      from veil2.scope_promotions
     where promoted_scope_id not in (
        select scope_id
	  from veil2.scope_promotions)
  ),
  recursive_scope_tree as
  (    
    select 1 as depth, 
           '(' || sp.promoted_scope_id::text || '.' ||
	   sp.scope_id || ').(' || sp.promoted_scope_type_id ||
	   '.' || sp.scope_type_id || ')' as path,
           sp.promoted_scope_id, sp.scope_id,
	   sp.promoted_scope_type_id, sp.scope_type_id
      from top_scopes ts
     inner join veil2.scope_promotions sp
        on sp.promoted_scope_id = ts.root_scope_id
       and sp.promoted_scope_type_id = ts.root_scope_type_id
     union all
    select depth + 1, 
    	   rst.path || '(' || sp.promoted_scope_id ||
	   '.' || sp.scope_id || ')',
           sp.promoted_scope_id, sp.scope_id,
	   sp.promoted_scope_type_id, sp.scope_type_id
      from recursive_scope_tree rst
     inner join veil2.scope_promotions sp
        on sp.promoted_scope_id = rst.scope_id
       and sp.promoted_scope_type_id = rst.scope_type_id
  ),
  format1 as
  (
    select st1.scope_type_name || ':' ||
    	    promoted_scope_id::text as parent,
           st2.scope_type_name || ':' || scope_id::text as child,
	   depth
      from recursive_scope_tree rst
     inner join veil2.scope_types st1
        on st1.scope_type_id = rst.promoted_scope_type_id
     inner join veil2.scope_types st2
        on st2.scope_type_id = rst.scope_type_id
    order by path
  )
select format('%' || ((depth)*16 - 14) || 's', '+-') ||
       substr('------------', length(parent)) || parent ||
       '-+' || substr('-------------', length(child)) ||
       child 
  from format1;

</pre>
<p>
Provides a simple ascii-formatted tree representation of our scope
promotions tree.  This is an aid to data visualisation for data
designers and administrators and is not used elsewhere in Veil2.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_promotable_privileges"></a>A.2.8. Promotable Privileges Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1480"></a>A.2.8.1. <code class="literal">promotable_privileges</code>
</h4></div></div></div>
<pre class="programlisting">
create view veil2.promotable_privileges (
  scope_type_id, privilege_ids)
as
select st.scope_type_id, bitmap_of(p.privilege_id)
  from veil2.scope_types st
 inner join veil2.privileges p
    on p.promotion_scope_type_id = st.scope_type_id
group by st.scope_type_id;

</pre>
<p>
Provide bitmaps of those privileges that may be promoted, mapped to the
context types to which they should promote.  This is not used elsewhere
in veil2 but may be useful for visualising data.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1483"></a>A.2.8.2. <code class="literal">promotable_privileges_info</code>
</h4></div></div></div>
<pre class="programlisting">
create view veil2.promotable_privileges_info (
  scope_type_id, privilege_ids)
as
select scope_type_id, to_array(privilege_ids)
  from veil2.promotable_privileges;

</pre>
<p>
As veil2.promotable_privileges with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_accessor_roles"></a>A.2.9. All Accessor Roles Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1488"></a>A.2.9.1. <code class="literal">all_accessor_roles</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_roles (
  accessor_id, role_id, context_type_id, context_id
) as
select accessor_id, role_id,
       context_type_id, context_id
  from veil2.accessor_roles;

</pre>
<p>
Provides all of an accessor's explicit role assignments, ie it does
not provide the personal_context role.  This view is used by the veil2
access control functions, and when adding new security context types,
this view is all that should usually need to be modified.
</p>
<p>
VPD Implementation Notes: If you have any explicitly assigned roles
that are not granted through the veil2.accessor_role table, you will
need to redefine this view.  For example if you have a project context
that is dependent on an accessor being assigned to a project you might
redefine the view as follows:
</p>
<p>
</p>
<pre class="programlisting">
create or replace
view veil2.all_accessor_roles (
  accessor_id, role_id, context_type_id, context_id
) as
select accessor_id, role_id,
       context_type_id, context_id
  from veil2.accessor_roles
 union all
select party_id, role_id,
       99,  -- id for project context_type
       project_id
  from project_parties;
</pre>
<p>
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1491"></a>A.2.9.2. <code class="literal">all_accessor_roles_plus</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_roles_plus as
select accessor_id, role_id,
       context_type_id, context_id
  from veil2.all_accessor_roles
 union all
select accessor_id, 2, 1, accessor_id
  from veil2.accessors;

</pre>
<p>
As all_accessor_roles but also showing personal_context role for each
accessor.  This is a developer view, aimed at development and
debugging.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_context_privs"></a>A.2.10. All Context Privs Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1496"></a>A.2.10.1. <code class="literal">all_context_privs</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_context_privs as
    -- We retrieve 2 distinct pairs of context keys: one for the
    -- scope within which the privilge applies (which for directly
    -- assigned roles and privileges is the context of the
    -- assignment), and one for the role-&gt;role mappings, which may be

</pre>
<p>
This is an internal view aimed to help development and debugging.
There should be no need to give anyone other than developers any
access to this.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1499"></a>A.2.10.2. <code class="literal">all_context_privs_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_context_privs_info (
  accessor_id, assignment_context_type_id,
  assignment_context_id, mapping_context_type_id,
  mapping_context_id, scope_type_id,
  scope_id, roles,
  privs, source) as
select accessor_id, assignment_context_type_id,
       assignment_context_id, mapping_context_type_id,
       mapping_context_id, scope_type_id,
       scope_id, to_array(roles),
       to_array(privs), source
  from veil2.all_context_privs;

</pre>
<p>
As veil2.direct_role_privileges_v with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_accessor_privs"></a>A.2.11. All Accessor Privs Views</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1504"></a>A.2.11.1. <code class="literal">all_accessor_privs_vv</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_privs_vv as
select * from veil2.all_accessor_privs_v;

</pre>
<p>
As veil2.all_accessor_privs_v
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1507"></a>A.2.11.2. <code class="literal">all_accessor_privs_vv_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_privs_vv_info (
  accessor_id,
  assignment_context_type_id, assignment_context_id,
  mapping_context_type_id, mapping_context_id,
  scope_type_id, scope_id,
  roles,  privs) as
select accessor_id,
       assignment_context_type_id, assignment_context_id,
       mapping_context_type_id, mapping_context_id,
       scope_type_id, scope_id,
       to_array(roles),  to_array(privs)
  from veil2.all_accessor_privs_vv;

</pre>
<p>
As veil2.all_accessor_privs_vv with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1510"></a>A.2.11.3. <code class="literal">all_accessor_privs_v</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_privs_v (
  accessor_id,
  assignment_context_type_id, assignment_context_id,
  mapping_context_type_id, mapping_context_id,
  scope_type_id, scope_id,
  roles,  privs) as
select accessor_id,
       assignment_context_type_id, assignment_context_id,
       mapping_context_type_id, mapping_context_id,
       scope_type_id, scope_id,
       union_of(roles),  union_of(privs)
  from veil2.all_context_privs
 group by accessor_id, assignment_context_type_id, assignment_context_id,
  mapping_context_type_id, mapping_context_id,
  scope_type_id, scope_id;

</pre>
<p>
Show all roles and privileges assigned to all accessors in all
contexts, excepting the implied personal context.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1513"></a>A.2.11.4. <code class="literal">all_accessor_privs_v_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_privs_v_info (
  accessor_id,
  assignment_context_type_id, assignment_context_id,
  mapping_context_type_id, mapping_context_id,
  scope_type_id, scope_id,
  roles,  privs) as
select accessor_id,
       assignment_context_type_id, assignment_context_id,
       mapping_context_type_id, mapping_context_id,
       scope_type_id, scope_id,
       to_array(roles),  to_array(privs)
  from veil2.all_accessor_privs_v;

</pre>
<p>
As veil2.all_accessor_privs_v with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1516"></a>A.2.11.5. <code class="literal">all_accessor_privs</code>
</h4></div></div></div>
<pre class="programlisting">
materialized view veil2.all_accessor_privs
  as select * from veil2.all_accessor_privs_v;

</pre>
<p>
Show all roles and privileges assigned to all accessors in all
contexts, excepting the implied personal context.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1519"></a>A.2.11.6. <code class="literal">all_accessor_privs_info</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_privs_info (
  accessor_id,
  assignment_context_type_id, assignment_context_id,
  mapping_context_type_id, mapping_context_id,
  scope_type_id, scope_id,
  roles,  privs) as
select accessor_id,
       assignment_context_type_id, assignment_context_id,
       mapping_context_type_id, mapping_context_id,
       scope_type_id, scope_id,
       to_array(roles),  to_array(privs)
  from veil2.all_accessor_privs;

</pre>
<p>
As veil2.all_accessor_privs with bitmaps shown as arrays.  Info
views are intended as developer-readable versions of the non-info
views.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_role_chains"></a>A.2.12. Role Chains View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1524"></a>A.2.12.1. <code class="literal">role_chains</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.role_chains as
with recursive role_chains
as
  (
    select rr.primary_role_id, rr.assigned_role_id,
    	   rr.primary_role_id::text || '-&gt;' ||

</pre>
<p>
This is a developer view.  It is intended for development and
debugging, and provides a way to view role mappings in a simple but
complete way.  Try it, it should immediately make sense.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_all_accessor_roles_plus"></a>A.2.13. All Accessor Roles Plus</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1529"></a>A.2.13.1. <code class="literal">all_accessor_roles_plus</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.all_accessor_roles_plus as
select accessor_id, role_id,
       context_type_id, context_id
  from veil2.all_accessor_roles
 union all
select accessor_id, 2, 1, accessor_id
  from veil2.accessors;

</pre>
<p>
As all_accessor_roles but also showing personal_context role for each
accessor.  This is a developer view, aimed at development and
debugging.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="view_privilege_assignments"></a>A.2.14. Privilege Assignments View</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idm1534"></a>A.2.14.1. <code class="literal">privilege_assignments</code>
</h4></div></div></div>
<pre class="programlisting">
view veil2.privilege_assignments as
select aar.accessor_id, rp.privilege_id,
       aar.context_type_id as ass_cntxt_type_id,
       aar.context_id as ass_cntxt_id,
       coalesce(p.promotion_scope_type_id,
                aar.context_type_id) as scope_type_id,
       coalesce(asp.promoted_scope_id,
	        aar.context_id) as scope_id,
       rc.primary_role_id as ass_role_id,
       rc.assigned_role_id as priv_bearing_role_id,
       rc.id_chain as role_id_mapping,
       rc.name_chain as role_name_mapping,
       rc.context_type_id as map_cntxt_type_id,
       rc.context_id as map_cntxt_id
  from (
    select role_id, privilege_id
      from veil2.role_privileges
    union all
    select 1, privilege_id
      from veil2.privileges
       ) rp
 inner join veil2.privileges p
    on p.privilege_id = rp.privilege_id
 inner join veil2.role_chains rc
    on rc.assigned_role_id = rp.role_id
 inner join veil2.all_accessor_roles_plus aar
    on aar.role_id = rc.primary_role_id
  left outer join veil2.all_scope_promotions asp
    on asp.scope_type_id = aar.context_type_id
   and asp.scope_id = aar.context_id
   and asp.promoted_scope_type_id = p.promotion_scope_type_id
   and asp.is_type_promotion;

</pre>
<p>
Developer view that shows how accessors get privileges.  It shows the
roles that the user is assigned, and the context in which they are
assigned, as well as the mappings from role to role to privilege which
give that resulting privilege to the accessor.
</p>
<p>
If you are uncertain how accessor 999 has privilege 333, then simply
run:
</p>
<p>
</p>
<pre class="programlisting">
select * 
  from veil2.privilege_assignments 
 where accessor_id = 999 
   and privilege_id = 333;
</pre>
<p>
</p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="apa.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="apa.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="apas03.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">A. <code class="literal">Veil2</code> ERD and Database Objects </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> A.3. Veil2 Functions and Triggers</td>
</tr>
</table>
</div>
</body>
</html>
