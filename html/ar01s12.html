<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>12. Setting Up Authentication and Session Management</title><link rel="stylesheet" type="text/css" href="veil2.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Veil2 0.5 (alpha) Documentation"><link rel="up" href="index.html" title="Veil2 0.5 (alpha) Documentation"><link rel="prev" href="ar01s11.html" title="11. Identify and Define Your Scope Types"><link rel="next" href="ar01s13.html" title="13. Create Initial Privileges"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s11.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s13.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">11. Identify and Define Your Scope Types </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 13. Create Initial Privileges</td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="setup_authent"></a>12. Setting Up Authentication and Session Management</h2></div></div></div><p>
    <code class="literal">Veil2</code> provides built-in mechanisms for
    authentication and session management.  You can choose to use
    these as they are, extend them, or replace them entirely.
  </p><p>
    This section provides an introduction to what is needed,
    references to more detailed explanations and a final, simple list,
    of <a class="link" href="ar01s12.html#authent_what" title="12.5. In Summary">actions</a> you need to take or
    consider.
  </p><p>
    The demo does very little in performing this step, but you may
    find some useful hints there.  Look for "STEP 3" in the file
    <code class="literal">demo/demo.sql</code>.
  </p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="authentication"></a>12.1. Authentication</h3></div></div></div><p>
      Authenticating users is hard.  There are many different ways to
      do it.  <code class="literal">Veil2</code> provides 2 default
      password-based mechanisms for authentication, and a mechanism
      for extensibility.  The built-in methods are:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    plaintext;
	  </p><p>
	    This is provided simply for testing.  With plaintext
	    authorization, a password is provided which is simply
	    checked against a copy stored in
	    <a class="link" href="apa.html#entity_authentication_detail" title="A.1.15. Authentication Details Table"><code class="literal">veil2.authentication_details</code></a>.
	  </p><p>
	    By default, this authentication mechanism is disabled.  It
	    is weak and insecure.  DO NOT USE IT.
	  </p></li><li class="listitem"><p>
	    bcrypt.
	  </p><p>
	    This is a password-based scheme, but the password is
	    stored as a bcrypted hash.  Creating this hash is slow,
	    which means that it is very difficult to determine, by
	    brute-force, the password that matches the hash.  This
	    mechanism should be be considered barely adequate from a
	    security standpoint as it still requires the plaintext
	    password to be sent to the database for checking.
	  </p><p>
	    This is good enough for most systems but a long way from
	    ideal.
	  </p></li></ul></div><p>
    </p><p>
      New authentication methods should be created by creating new
      authentication functions and new records in <a class="link" href="apa.html#entity_authentication_type" title="A.1.12. Authentication Types Table"><code class="literal">veil2.authentication_types</code></a>.
    </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm838"></a>12.2. Associate Your Users With Their Authentication
    Contexts</h3></div></div></div><p>
      If your users do not all authenticate in the same context you
      will need to redefine the <code class="literal"><a class="link" href="apas02.html#view_accessor_contexts" title="A.2.5. Accessor Contexts View">veil2.accessor_contexts</a></code>
      view.  This view associates accessors with <a class="link" href="ar01s05.html#authentication_context" title="5.7. Authentication Contexts">authentication
      contexts</a>.  Step 3 in the demo provides a good example of
      this.
    </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm844"></a>12.3. Define Your <code class="literal">get_accessor()</code> Function</h3></div></div></div><p>
      For user authentication purposes <code class="literal">Veil2</code> needs
      the <code class="literal">accessor_id</code> for the <code class="literal"><a class="link" href="apa.html#entity_accessor" title="A.1.9. Accessors Table">accessors</a></code> record that
      represents the user.  Since usernames, email addresses and
      whatever else might be used to uniquely identify a user, in
      their <a class="link" href="ar01s05.html#authentication_context" title="5.7. Authentication Contexts">authentication
      context</a> are stored in tables
      external to <code class="literal">Veil2</code>, we need a function that
      returns an <code class="literal">accessor_id</code> for a username.  The
      <code class="literal">
	<a class="link" href="apas03.html#func_get_accessor" title="A.3.9. get_accessor()">get_accessor()</a></code>
      function is that function. 
    </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="session_management"></a>12.4. Session Management</h3></div></div></div><p>
      There are 2 distinct types of sessions provided:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    shared-connection sessions;
	  </p><p>
	    These are used when a single database user account is used
	    to handle multiple connected users.  Each database
	    connection will typically be shared among many users
	    through some sort of connection-pooling system.  This is
	    the type of session generally used by web applications.
	  </p><p>
	    It is important with such systems that we can reliably
	    identify which user is connected, and that the privileges
	    of one user are not inadvertently transferred to another.
	    This means that when the connection starts to be used by a
	    new user there must be some form of secure identification
	    of the user.
	  </p></li><li class="listitem"><p>
	    dedicated sessions.
	  </p><p>
	    These are typically used for reporting applications, where
	    each reporting user will have their own database account.
	    In this case, <code class="literal">Veil2</code> determines the
	    user's access rights based upon database roles, and there
	    is no need for further authentication - we assume that
	    database authentication is sufficient.
	  </p></li></ul></div><p>
    </p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idm869"></a>12.4.1. Shared-Connection Sessions</h4></div></div></div><p>
	Within a shared connection environment, such as provided by
	most web applications, a database connection will be shared
	amongst many users.  When the application needs to perform
	some database action on behalf of a user, the connection will
	be retrieved from the pool, and possibly re-initialized,
	before executing one or more queries on the user's behalf.
      </p><p>
	Unless we provide the connection with extra information, the
	database cannot know which user it is executing queries for.
      </p><p>
	<code class="literal">Veil2</code> provides 3 session management
	functions to identify and keep track of users:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">veil2.create_session()</code>;</li><li class="listitem"><code class="literal">veil2.open_connection()</code>;</li><li class="listitem"><code class="literal">veil2.close_connection()</code>.</li></ul></div><p>
	Your application server must call
	<code class="literal">create_session()</code> to identify each new user,
	and <code class="literal">open_connection()</code> before the user begins
	issuing queries.  <code class="literal">close_connection()</code> should be
	called before returning the database connection to the pool.
      </p><p>
	A detailed description of this can be found in the <a class="link" href="apb.html" title="B. Veil2 Authentication Protocols">Authentication Protocols</a>
	appendix, which describes the functions, their parameters, and
	describes error handling.
      </p><p>
	
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idm888"></a>12.4.2. Dedicated Sessions</h4></div></div></div><p>
	If you have users that connect directly to your database,
	perhaps through some reporting tool, you will want to set them
	up as users of dedicated sessions.
      </p><p>
	This is done by providing the database username to a
	<code class="literal">veil2.accessors</code>
	record.
      </p><p>
	To begin a dedicated session after connecting to the database,
	the user must call <code class="literal">veil2.hello()</code>, which
	will return true if <code class="literal">Veil2</code> has successfully
	authenticated the user. 
	</p><pre class="programlisting">
select veil2.hello();
	</pre><p>
	If your reporting tool does not allow such function calls, you
	will need to create a view that calls it, which the reporting
	tool can call.  Something like this would work:
	</p><pre class="programlisting">
create or replace 
view session_start as 
select veil2.hello();
	</pre><p>
	  or, if you need the view to return no rows:
	</p><pre class="programlisting">
create or replace 
view session_start as 
  with session as (
  select 1 as result from veil2.hello()
  )
select * from session where result = 0;
	</pre><p>
	</p><p>
	  For an example of this, take a look at the
	  <code class="literal">Veil2</code>unit tests.  The database user
	  <code class="literal">veil2_alice</code> is set up as a dedicated
	  session user (as well as a shared session user).
	</p><p>
      </p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="authent_what"></a>12.5. In Summary</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  For shared-session use, choose an authentication system.
	  You may need to implement it.  You should disable (in
	  <code class="literal"><a class="link" href="apa.html#entity_authentication_type" title="A.1.12. Authentication Types Table">veil2.authentication_types</a></code>
	  the authentication systems you do not want to use. 
	</p></li><li class="listitem"><p>
	  Redefine the <code class="literal"><a class="link" href="apas02.html#view_accessor_contexts" title="A.2.5. Accessor Contexts View">accessor_contexts</a></code>
	  view, if neccessary, to associate users with their <a class="link" href="ar01s05.html#authentication_context" title="5.7. Authentication Contexts">authentication
	  contexts</a>.
	</p></li><li class="listitem"><p>
	  Implement <code class="literal"><a class="link" href="apas03.html#func_get_accessor" title="A.3.9. get_accessor()">get_accessor()</a></code>
	  to retrieve <code class="literal">accessor_id</code>s based on
	  usernames or whatever.
	</p></li><li class="listitem"><p>
	  For shared-session use, figure out how to implement the
	  shared session management protocol in your application
	  server(s). 
	</p></li><li class="listitem"><p>
	  For dedicated sessions users, create
	  <code class="literal">
	    <a class="link" href="apa.html#entity_accessor" title="A.1.9. Accessors Table">veil2.accessors</a></code>
	  records.  Maybe create a view that calls
	  <code class="literal"><a class="link" href="apas03.html#func_hello" title="A.3.16. hello()">veil2.hello()</a></code>. 
	</p></li></ul></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s11.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s13.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">11. Identify and Define Your Scope Types </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 13. Create Initial Privileges</td></tr></table></div></body></html>
