<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>16. Link Your Scopes and Security Contexts</title>
<link rel="stylesheet" type="text/css" href="veil2.css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="index.html" title="Veil2 0.5 (alpha) Documentation">
<link rel="up" href="index.html" title="Veil2 0.5 (alpha) Documentation">
<link rel="prev" href="ar01s15.html" title="15. Link Your Users To Veil2's Accessors">
<link rel="next" href="ar01s17.html" title="17. Create Scope Promotions">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ar01s15.html">Prev</a> </td>
<td width="20%" align="center"> </td>
<td width="40%" align="right"> <a accesskey="n" href="ar01s17.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">15. Link Your Users To <code class="literal">Veil2</code>'s Accessors </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> 17. Create Scope Promotions</td>
</tr>
</table>
<hr>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="link_scopes"></a>16. Link Your Scopes and Security Contexts</h2></div></div></div>
<p>
    The <code class="literal">Veil2 <a class="link" href="apa.html#entity_scope" title="A.1.5. Scopes Table">scopes</a></code> table is the most
    important link between <code class="literal">Veil2</code> and the database
    that it is protecting.  It provides the semantic link between
    <a class="link" href="ar01s05.html#scopes" title="5.2. Scopes">scopes</a> as understood by the security
    model, and the <a class="link" href="ar01s05.html#security-contexts" title="5.5. Security Contexts">security
    contexts</a> provided or implied by the data model.
  </p>
<p>
    The simplest, and recommended, way to implement these links is by
    adding foreign-key columns and relationships to the <code class="literal">Veil2
    <a class="link" href="apa.html#entity_scope" title="A.1.5. Scopes Table">scopes</a></code> table.
  </p>
<p>
    Look for STEP 7 in the file <code class="literal">demo/demo.sql</code>.
  </p>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm1089"></a>16.1. Create Foreign Key Links</h3></div></div></div>
<p>
      For each relational security context, you will add columns to
      the <code class="literal">scopes</code> table.  For instance if you have a
      project context based on a user's membership of projects, and
      you <code class="literal">project</code> table has an integer
      <code class="literal">project_id</code> field as its primary key, you
      would do the following:
      </p>
<pre class="programlisting">
alter table veil2.scopes
  add column project_id integer;

alter table veil2.scopes
  add constraint scope__project_fk
  foreign key (project_id)
  references projects(project_id)
  on update cascade on delete cascade;
      </pre>
<p>
    </p>
<p>
      Using the cascade options ensures that deletions and updates of
      the primary keys in the <code class="literal">projects</code> table are
      propagated to <code class="literal">scopes</code>.  This saves us from
      having to implement our own triggers for updates and deletions.
    </p>
<p>
      It is wise to also ensure that project_id fields are only used
      with the appropriate scope type.  A check constraint like the
      following should be used:
      </p>
<pre class="programlisting">
alter table veil2.scopes
  add constraint scope__check_project_fk_type
  check (case when scope_type_id = 6 then
              project_id is not null
	 else project_id is null end);
      </pre>
<p>
      Where, we assume, a <code class="literal">scope_type_id</code> of
      <code class="literal">6</code> means project scope.
    </p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm1103"></a>16.2. Create Insertion Triggers</h3></div></div></div>
<p>
      Next, we want to ensure that new <code class="literal">projects</code>
      records are automatically recorded in the
      <code class="literal">scopes</code> table.  You will add an on insert
      trigger to do this, the details of which are left to the reader.
    </p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm1108"></a>16.3. Link Existing Records</h3></div></div></div>
<p>
      The final step is to populate scope records for your existing
      projects.  Something like this:
      </p>
<pre class="programlisting">
insert 
  into veil2.scopes
      (scope_type_id, scope_id, project_id)
select 6, nextval('veil2.scope_id_seq'), project_id
  from projects p
 where not exists (
    select null
      from veil2.scopes s
     where s.project_id = p.project_id);
      </pre>
<p>
      Note that you would have to create the sequence used above as
      this is not provided for you by default.
    </p>
<p>
      The not-exists clause is worth using as you will be able to
      safely re-run this insert at any time if your tables get out of
      step.
    </p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm1113"></a>16.4. In Summary</h3></div></div></div>
<p>
      For each relational context you will add foreign key columns,
      create foreign key and check constraints, create an insert
      trigger and populate the <code class="literal">scopes</code> table
      records.
    </p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ar01s15.html">Prev</a> </td>
<td width="20%" align="center"> </td>
<td width="40%" align="right"> <a accesskey="n" href="ar01s17.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">15. Link Your Users To <code class="literal">Veil2</code>'s Accessors </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> 17. Create Scope Promotions</td>
</tr>
</table>
</div>
</body>
</html>
