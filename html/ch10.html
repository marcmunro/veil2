<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Chapter 10. Setting Up Authentication and Session Management (STEP 3)</title>
<link rel="stylesheet" type="text/css" href="veil2.css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="index.html" title="Veil2 0.9.1 (beta) Documentation">
<link rel="up" href="pt02.html" title="Part II. Creating Your Veil2-based VPD Step By Step">
<link rel="prev" href="ch09.html" title="Chapter 9. Identify and Define Your Scope Types (STEP 2)">
<link rel="next" href="ch11.html" title="Chapter 11. Link Your Users To Veil2's Accessors (STEP 4)">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch09.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="pt02.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="ch11.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 9. Identify and Define Your Scope Types (STEP 2) </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 11. Link Your Users To <code class="literal">Veil2</code>'s Accessors (STEP
  4)</td>
</tr>
</table>
<hr>
</div>
<div class="chapter">
<div class="titlepage"><div><div><h2 class="title">
<a name="setup_authent"></a>Chapter 10. Setting Up Authentication and Session Management (STEP 3)</h2></div></div></div>
<p>
    <code class="literal">Veil2</code> provides built-in mechanisms for
    authentication and session management.  You can choose to use
    these as they are, extend them, or replace them entirely.
  </p>
<p>
    Look for "STEP 3" in the file
    <code class="literal">veil2_demo--&lt;version&gt;.sql</code>.
  </p>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="idm759"></a>10.1. Create Your Authentication Methods</h2></div></div></div>
<p>
      If you need an authentication method other than
      <code class="literal">bcrypt</code> you will need to define it as a type
      and then create authentication functions for it.
    </p>
<p>
      New authentication methods should be created by creating new
      authentication functions and new records in <a class="link" href="apa.html#entity_authentication_type" title="A.1.12. Authentication Types Table"><code class="literal">veil2.authentication_types</code></a>.
    </p>
<p>
      New authentication functionality is created by creating new
      functions with the same signature as <a class="link" href="apc.html#func_authenticate_bcrypt" title="C.3.3. authenticate_bcrypt()"><code class="literal">veil2.authenticate_bcrypt()</code></a>.
    </p>
<p>
      The <code class="literal">Veil2</code> demo chooses to use plaintext
      authentication which is a really terrible idea but makes for an
      easy implementation.  Don't do this.
    </p>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="idm771"></a>10.2. Associate Accessors And Authentication Contexts</h2></div></div></div>
<p>
      <code class="literal">Veil2</code> determines the authentication context
      for an accessor through the <code class="literal"><a class="link" href="apb.html#view_accessor_contexts" title="B.1.1.1. Accessor Contexts View">veil2.accessor_contexts</a></code>
      view.  Since the actual association between them is provided by
      your database, you must provide a custom version of this view
      (called <code class="literal">veil2.my_accessor_contexts</code>). 
    </p>
<p>
      To make your version of the view take effect, as described <a class="link" href="ch21.html#use_func_init">here</a>, use the <code class="literal"><a class="link" href="apc.html#func_init" title="C.2.10. init()">veil2.init()</a></code> function.
    </p>
<p>
      Note that <code class="literal"><a class="link" href="apc.html#func_implementation_status" title="C.8.9. implementation_status()">veil2.implementation_status()</a></code>
      will also install your user-defined functions and views as it
      itself calls <code class="literal">veil2.init()</code>.
    </p>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="idm786"></a>10.3. Define Your <code class="literal">my_get_accessor()</code> Function</h2></div></div></div>
<p>
      For user authentication purposes <code class="literal">Veil2</code> needs
      the <code class="literal">accessor_id</code> for the <code class="literal"><a class="link" href="apa.html#entity_accessor" title="A.1.9. Accessors Table">accessors</a></code> record that
      represents the user.  Since <code class="literal">Veil2</code> does not
      itself store usernames, email addresses and whatever else that
      might be used to uniquely identify a user in their <a class="link" href="ch04.html#authentication_context" title="4.7. Authentication Contexts">authentication context</a>,
      we need a function that returns an
      <code class="literal">accessor_id</code> for a username.  The
      <code class="literal">
	<a class="link" href="apc.html#func_get_accessor" title="C.4.4. get_accessor()">get_accessor()</a></code>
      function is that function.
    </p>
<p>
      Your version of this function will be called
      <code class="literal">veil2.my_get_accessor()</code>.  As described above
      you make it current by calling <code class="literal"><a class="link" href="apc.html#func_init" title="C.2.10. init()">veil2.init()</a></code>.
    </p>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="session_management"></a>10.4. Notes on Session Management</h2></div></div></div>
<p>
      If your application requires any special session management
      functionality, this is the time to create it.  There is little
      we can say here about what that functionality might be, as it
      will very much depend on your needs.  This section simply tries
      to provide some useful background information.
    </p>
<p>
      There are 2 distinct types of sessions provided:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>
	    shared-connection sessions;
	  </p>
<p>
	    These are used when a single database user account is used
	    to handle multiple connected users.  Each database
	    connection will typically be shared among many users
	    through some sort of connection-pooling system.  This is
	    the type of session generally used by web applications.
	  </p>
<p>
	    It is important with such systems that we can reliably
	    identify which user is connected, and that the privileges
	    of one user are not inadvertently transferred to another.
	    This means that when the connection starts to be used by a
	    new user there must be some form of secure identification
	    of the user.
	  </p>
</li>
<li class="listitem">
<p>
	    dedicated sessions.
	  </p>
<p>
	    These are typically used for reporting applications, where
	    each reporting user will have their own database account.
	    In this case, <code class="literal">Veil2</code> determines the
	    user's access rights based upon database roles, and there
	    is no need for further authentication - we assume that
	    database authentication is sufficient.
	  </p>
</li>
</ul></div>
<p>
    </p>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm816"></a>10.4.1. Shared-Connection Sessions</h3></div></div></div>
<p>
	Within a shared connection environment, such as provided by
	most web applications, a database connection will be shared
	amongst many users.  When the application needs to perform
	some database action on behalf of a user, the connection will
	be retrieved from the pool, and possibly re-initialized,
	before executing one or more queries on the user's behalf.
      </p>
<p>
	Unless we provide the connection with extra information, the
	database cannot know which user it is executing queries for.
      </p>
<p>
	<code class="literal">Veil2</code> provides 3 session management
	functions to identify and keep track of users:
	</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<code class="literal">veil2.create_session()</code>;</li>
<li class="listitem">
<code class="literal">veil2.open_connection()</code>;</li>
<li class="listitem">
<code class="literal">veil2.close_connection()</code>.</li>
</ul></div>
<p>
	Your application server must call
	<code class="literal">create_session()</code> to identify each new user,
	and <code class="literal">open_connection()</code> before the user begins
	issuing queries.  <code class="literal">close_connection()</code> should be
	called before returning the database connection to the pool.
      </p>
<p>
	A detailed description of this can be found in the <a class="link" href="ape.html" title="Appendix E. Veil2 Authentication Protocols">Authentication Protocols</a>
	appendix, which describes the functions, their parameters, and
	describes error handling.
      </p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="idm834"></a>10.4.2. Dedicated Sessions</h3></div></div></div>
<p>
	If you have users that connect directly to your database,
	perhaps through some reporting tool, you will want to set them
	up as users of dedicated sessions.
      </p>
<p>
	This is done by recording the database username in the
	<code class="literal">username</code> field of the <code class="literal"><a class="link" href="apa.html#entity_accessor" title="A.1.9. Accessors Table">veil2.accessors</a></code>
	record.
      </p>
<p>
	To begin a dedicated session after connecting to the database,
	the user must call <code class="literal"><a class="link" href="apc.html#func_hello" title="C.4.29. hello()">veil2.hello()</a></code>, which
	will return true if <code class="literal">Veil2</code> has successfully
	authenticated the user. 
	</p>
<pre class="programlisting">
select veil2.hello();
	</pre>
<p>
	If your reporting tool does not allow such function calls, you
	will need to create a view that calls it, which the reporting
	tool can call.  Something like this would work:
	</p>
<pre class="programlisting">
create or replace 
view session_start as 
select veil2.hello();
	</pre>
<p>
	  or, if you need the view to return no rows:
	</p>
<pre class="programlisting">
create or replace 
view session_start as 
  with session as (
  select 1 as result from veil2.hello()
  )
select * from session where result = 0;
	</pre>
<p>
      </p>
<p>
	For an example of this, take a look at the
	<code class="literal">Veil2</code> unit tests (in file
	<code class="literal">tests/test_session.sql</code>).  The database
	user <code class="literal">veil2_alice</code> is set up as a dedicated
	session user (as well as a shared session user).
      </p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch09.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="pt02.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="ch11.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 9. Identify and Define Your Scope Types (STEP 2) </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 11. Link Your Users To <code class="literal">Veil2</code>'s Accessors (STEP
  4)</td>
</tr>
</table>
</div>
</body>
</html>
